<div class="overall-wrapper" appMaximize #fcmGuide="maximize" id="fcmGuide">
  <!-- Header -->
  <div class="wrapper">
    <img
      class="swap"
      *ngIf="fcmGuide.checkfullscreen() == 'hide'"
      (click)="fcmGuide.toggle()"
      src="../../../assets/expand.svg"
      alt="Expand"
    />
    <img
      class="swap"
      *ngIf="fcmGuide.checkfullscreen() != 'hide'"
      (click)="fcmGuide.toggle()"
      src="../../../assets/Minimize icon.svg"
      alt="Minimize"
    />
    <div class="header">
      <h1>Firebase Cloud Messaging Integration Guide</h1>
      <p>Step-by-step guide for integrating FCM in Angular and NestJS</p>
    </div>
  </div>

  <!-- Steps -->
  <div class="examples">

    <!-- Frontend Section Header -->
    
      <h2> Frontend Setup (Angular)</h2>
    

    <!-- Step 1 -->
    <div class="step">
      <h2>1. Firebase Setup</h2>
      <p><strong>Create a Firebase Project:</strong></p>
      <p>Sign up for a free Firebase account and create a new project. Obtain the configuration key and Web Push certificates (VAPID Key and Sender ID).</p>
      <p style="margin-top: 15px;"><strong>Firebase Configuration:</strong></p>
      <pre #code1>export const firebaseConfig = &#123;
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
  measurementId: "YOUR_MEASUREMENT_ID",
  vapidKey: "YOUR_VAPID_KEY"
&#125;;</pre>
      <button   (click)="copyCode(code1, tooltip1)">Copy Code</button>
      <span class="tooltip" #tooltip1>Copied!</span>
    </div>

    <!-- Step 2 -->
    <div class="step">
      <h2>2. Create firebase-messaging-sw.js</h2>
      <p>Add the following file in the <code>src</code> folder:</p>
      <pre #code2>importScripts("https://www.gstatic.com/firebasejs/10.1.0/firebase-app-compat.js");
importScripts("https://www.gstatic.com/firebasejs/10.1.0/firebase-messaging-compat.js");

firebase.initializeApp(&#123;
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID",
  measurementId: "YOUR_MEASUREMENT_ID"
&#125;);

const messaging = firebase.messaging();

messaging.onBackgroundMessage((payload) => &#123;
  console.log("Received background message:", payload);
  const notificationTitle = payload.notification.title;
  const notificationOptions = &#123;
    body: payload.notification.body,
    icon: "/assets/icons/icon-72x72.png"
  &#125;;
  self.registration.showNotification(notificationTitle, notificationOptions);
&#125;);</pre>
      <button class="copy-btn"  (click)="copyCode(code2, tooltip2)">Copy Code</button>
      <span class="tooltip" #tooltip2>Copied!</span>
    </div>

    <!-- Step 3 -->
    <div class="step">
      <h2>3. Create manifest.json</h2>
      <p>Add the following file in the (firebase -> settings -> Cloud Messaging) <code>src</code> folder:</p>
      <pre #code3>&#123;
  "gcm_sender_id": "YOUR_SENDER_ID"
&#125;</pre>
      <button class="copy-btn"  (click)="copyCode(code3, tooltip3)">Copy Code</button>
      <span class="tooltip" #tooltip3>Copied!</span>
    </div>

    <!-- Step 4 -->
    <div class="step">
      <h2>4. Update angular.json</h2>
      <p>Add the following under the assets section:</p>
      <pre #code4>"assets": [
  "src/favicon.ico",
  "src/assets",
  &#123;
    "glob": "firebase-messaging-sw.js",
    "input": "src",
    "output": "/"
  &#125;,
  &#123;
    "glob": "manifest.json",
    "input": "src",
    "output": "/"
  &#125;
]</pre>
      <button class="copy-btn"  (click)="copyCode(code4, tooltip4)">Copy Code</button>
      <span class="tooltip" #tooltip4>Copied!</span>
    </div>

    <!-- Step 5 -->
    <div class="step">
      <h2>5. Get Device Token</h2>
      <p>Request notification permission and retrieve the device token:</p>
      <pre #code5>import &#123; isPlatformBrowser &#125; from '&#64;angular/common';
import &#123; getMessaging, getToken, onMessage &#125; from 'firebase/messaging';

ngOnInit(): void &#123;
  if (isPlatformBrowser(this.platformId)) &#123;
    this.requestPermission();
    this.listen();
  &#125;
&#125;

async requestPermission() &#123;
  try &#123;
    const messaging = getMessaging();
    const permission = await Notification.requestPermission();
    
    if (permission !== 'granted') &#123;
      return null;
    &#125;
    
    const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
    const currentToken = await getToken(messaging, &#123;
      vapidKey: environment.firebaseConfig.vapidKey,
      serviceWorkerRegistration: registration
    &#125;);
    
    console.log('Token result:', currentToken);
    this.deviceToken = currentToken;
    return currentToken;
  &#125; catch (err) &#123;
    console.error('Error while fetching device token:', err);
    return null;
  &#125;
&#125;</pre>
      <button class="copy-btn"  (click)="copyCode(code5, tooltip5)">Copy Code</button>
      <span class="tooltip" #tooltip5>Copied!</span>
    </div>

    <!-- Step 6 -->
    <div class="step">
      <h2>6. Listen for Notifications</h2>
      <p>Handle incoming notifications:</p>
      <pre #code6>listen() &#123;
  const messaging = getMessaging();
  onMessage(messaging, (payload) => &#123;
    console.log('Message received:', payload);
    this.message = payload;
    this.displayNotification(payload);
  &#125;);
&#125;

displayNotification(payload: any): void &#123;
  if (Notification.permission === 'granted') &#123;
    const &#123; title, body &#125; = payload.notification;
    const options: NotificationOptions = &#123;
      body,
    &#125;;
    
    const notification = new Notification(title, options);
    
    notification. (click) = (event) => &#123;
      event.preventDefault();
      window.open("http://www.mozilla.org", "_blank");
    &#125;;
  &#125;
&#125;</pre>
      <button class="copy-btn"  (click)="copyCode(code6, tooltip6)">Copy Code</button>
      <span class="tooltip" #tooltip6>Copied!</span>
    </div>

    <!-- Step 7 -->
    <div class="step">
      <h2>7. Update Token in Database</h2>
      <p>Save the device token to your backend:</p>
      <pre #code7>notificationToken() &#123;
  this.apiService.Post(ApiList.notificationToken, &#123; 
    deviceToken: this.deviceToken 
  &#125;).subscribe(&#123;
    next: (res) => &#123;
      console.log('FCM token stored successfully:', res);
    &#125;,
    error: (error) => &#123;
      console.error('Error while storing token:', error);
    &#125;
  &#125;);
&#125;</pre>
      <button class="copy-btn"  (click)="copyCode(code7, tooltip7)">Copy Code</button>
      <span class="tooltip" #tooltip7>Copied!</span>
    </div>

    <!-- Step 8 -->
    <div class="step">
      <h2>8. Install Required Packages</h2>
      <pre #code8>npm install firebase &#64;angular/fire</pre>
      <button class="copy-btn"  (click)="copyCode(code8, tooltip8)">Copy Code</button>
      <span class="tooltip" #tooltip8>Copied!</span>
    </div>

    <!-- Backend Section Header -->
      <h2> Backend Setup (NestJS)</h2>

    <!-- Step 9 -->
    <div class="step">
      <h2>1. Firebase Service Account</h2>
      <p><strong>Steps:</strong></p>
      <p>1. Create a Firebase <strong>service account and download the private key JSON file.</strong></p>
      <p>2. Add the JSON file inside the <code>src</code> folder of your NestJS project.</p>
      <p>3. Initialize Firebase in <code>main.ts</code></p>
      <pre #code91>
import &#123; bootstrapApplication &#125; from '&#64;angular/platform-browser';
import &#123; appConfig &#125; from './app/app.config';
import &#123; AppComponent &#125; from './app/app.component';
import &#123; initializeApp &#125; from 'firebase/app';
import &#123; firebaseConfig &#125; from './environments/env';

const app = initializeApp(firebaseConfig);
console.log('Firebase initialized:', app.name);

bootstrapApplication(AppComponent, appConfig)
  .catch((err) => console.error(err));
      </pre>
      <button class="copy-btn"  (click)="copyCode(code91, tooltip91)">Copy Code</button>
      <span class="tooltip" #tooltip91>Copied!</span>
    </div>

    <!-- Step 10 -->
    <div class="step">
      <h2>2. Create Firebase Service</h2>
      <pre #code10>import &#123; Injectable, OnModuleInit &#125; from '&#64;nestjs/common';
import * as firebase from 'firebase-admin';
import &#123; join &#125; from 'path';

&#64;Injectable()
export class FirebaseService implements OnModuleInit &#123;
  onModuleInit() &#123;
    if (!firebase.apps.length) &#123;
      firebase.initializeApp(&#123;
        credential: firebase.credential.cert(join(process.cwd(), 'firebase-sdk.json')),
      &#125;);
    &#125;
  &#125;

  async sendNotification(token: string, title: string, body: string): Promise&lt;string&gt; &#123;
    try &#123;
      const message = &#123;
        notification: &#123;
          title,
          body,
        &#125;,
        token,
      &#125;;
      
      const response = await firebase.messaging().send(message);
      console.log('Notification response:', response);
      return response;
    &#125; catch (error) &#123;
      if (error.errorInfo?.code === 'messaging/registration-token-not-registered') &#123;
        console.warn('Invalid token detected. Removing from database:', token);
        // Optional: Remove the token from your database here
      &#125; else &#123;
        console.error('Error sending notification:', error);
      &#125;
      throw error;
    &#125;
  &#125;
&#125;</pre>
      <button class="copy-btn"  (click)="copyCode(code10, tooltip10)">Copy Code</button>
      <span class="tooltip" #tooltip10>Copied!</span>
    </div>

    <!-- Step 11 -->
    <div class="step">
      <h2>3. Use Service in Controller</h2>
      <pre #code11>async sendNotification(userId: number): Promise&lt;void&gt; &#123;
  const token = await this.UserNotificationMappingRepository.findOne(&#123;
    where: &#123; userId: userId, isActive: true &#125;
  &#125;);
  
  if (!token) &#123;
    throw new Error('No active notification token found for the user');
  &#125;
  
  this.firebaseService.sendNotification(
    token.notificationToken,
    "Successfully notification showing",
    "Test"
  );
&#125;</pre>
      <button class="copy-btn"  (click)="copyCode(code11, tooltip11)">Copy Code</button>
      <span class="tooltip" #tooltip11>Copied!</span>
    </div>

    <!-- Step 12 -->
    <div class="step">
      <h2>4. Install Required Packages</h2>
      <pre #code12>npm install firebase-admin</pre>
      <button class="copy-btn"  (click)="copyCode(code12, tooltip12)">Copy Code</button>
      <span class="tooltip" #tooltip12>Copied!</span>
    </div>

    <!-- How it Works -->
    <div class="step">
      <h2>ðŸŽ¯ How It Works</h2>
      <p><strong>1. Frontend:</strong> Request notification permission and get device token</p>
      <p><strong>2. Store Token:</strong> Save the device token in your database linked to the user</p>
      <p><strong>3. Backend:</strong> Use Firebase Admin SDK to send notifications to specific device tokens</p>
      <p><strong>4. Receive:</strong> User receives push notifications even when the app is in the background</p>
      <p style="margin-top: 15px;"><strong>Result:</strong> You can now send targeted push notifications to specific users through their device tokens!</p>
    </div>

  </div>
</div>