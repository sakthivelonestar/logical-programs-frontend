<div class="overall-wrapper" id="sqlStoredProceduresFunctions">
        <div class="wrapper">
            <img class="swap" src="../../../assets/expand.svg" alt="Expand">
            <img class="swap" src="../../../assets/Minimize icon.svg" alt="Minimize">
            <div class="header">
                <p><span class="question">What:</span> SQL stored procedures and functions are <strong>saved database programs that help you do common tasks quickly and easily, like calculating salaries or finding specific employees.</strong></p>
                <p><span class="question">Why:</span> SQL stored procedures and functions are important because they <strong>make your database work faster, keep your code organized, prevent errors, and let you reuse the same code multiple times.</strong></p>
                <p><span class="question">Where:</span> SQL stored procedures and functions are used <strong>in business applications, employee management systems, sales tracking, inventory control, and anywhere you need to do the same database tasks repeatedly.</strong></p>
            </div>
        </div>
        <div class="examples">
            <div class="step">
                <h4>Step 1: Simple Functions - Getting Single Values</h4>
                <pre><code>-- Function to calculate average salary for the whole company
CREATE FUNCTION dbo.GetCompanyAverageSalary()
RETURNS DECIMAL(10,2)
AS
BEGIN
    DECLARE &#64;average_salary DECIMAL(10,2);
    SELECT &#64;average_salary = AVG(salary) FROM employees;
    RETURN &#64;average_salary;
END;

-- Function to get average salary for a specific department
CREATE FUNCTION dbo.GetDepartmentAverageSalary(&#64;department_id INT)
RETURNS DECIMAL(10,2)
AS
BEGIN
    DECLARE &#64;dept_average DECIMAL(10,2);
    SELECT &#64;dept_average = AVG(salary) 
    FROM employees 
    WHERE department_id = &#64;department_id;
    RETURN &#64;dept_average;
END;

-- Function that returns a table of high-earning employees
CREATE FUNCTION dbo.GetHighEarningEmployees()
RETURNS TABLE
AS
RETURN (
    SELECT 
        employee_id,
        first_name,
        last_name,
        salary,
        dbo.GetCompanyAverageSalary() as company_average
    FROM employees
    WHERE salary > dbo.GetCompanyAverageSalary()
);

-- Function to get employees by city
CREATE FUNCTION dbo.GetEmployeesByCity(&#64;city VARCHAR(50))
RETURNS TABLE
AS
RETURN (
    SELECT 
        e.employee_id,
        e.first_name,
        e.last_name,
        e.salary,
        d.department_name
    FROM employees e
    JOIN departments d ON e.department_id = d.department_id
    WHERE d.city = &#64;city
);

-- How to use these functions
SELECT dbo.GetCompanyAverageSalary() as 'Company Average Salary';
SELECT dbo.GetDepartmentAverageSalary(1) as 'Department 1 Average';
SELECT * FROM dbo.GetHighEarningEmployees();
SELECT * FROM dbo.GetEmployeesByCity('New York');</code></pre>
                <p>Simple functions help you get information from your database easily. Some return single numbers (like average salary), while others return tables of data (like lists of employees).</p>
            </div>
            
            <div class="step">
                <h4>Step 2: Stored Procedures - Doing Multiple Things at Once</h4>
                <pre><code>-- Procedure to find employees earning more than their department average
CREATE PROCEDURE dbo.FindTopPerformers
AS
BEGIN
    SELECT 
        e.employee_id,
        e.first_name,
        e.last_name,
        e.salary,
        e.department_id,
        dbo.GetDepartmentAverageSalary(e.department_id) as dept_average
    FROM employees e
    WHERE e.salary > dbo.GetDepartmentAverageSalary(e.department_id)
    ORDER BY e.salary DESC;
END;

-- Procedure to find departments with high earners
CREATE PROCEDURE dbo.FindDepartmentsWithHighEarners
    &#64;minimum_salary DECIMAL(10,2) = 75000
AS
BEGIN
    SELECT 
        d.department_id,
        d.department_name,
        d.city,
        COUNT(e.employee_id) as high_earner_count,
        AVG(e.salary) as average_high_earner_salary
    FROM departments d
    JOIN employees e ON d.department_id = e.department_id
    WHERE e.salary >= &#64;minimum_salary
    GROUP BY d.department_id, d.department_name, d.city
    ORDER BY high_earner_count DESC;
END;

-- Procedure to find empty departments (no employees)
CREATE PROCEDURE dbo.FindEmptyDepartments
AS
BEGIN
    SELECT 
        d.department_id,
        d.department_name,
        d.city,
        'No employees assigned' as status
    FROM departments d
    LEFT JOIN employees e ON d.department_id = e.department_id
    WHERE e.employee_id IS NULL;
END;

-- Procedure to give salary raises
CREATE PROCEDURE dbo.GiveSalaryRaises
    &#64;department_id INT,
    &#64;raise_percentage DECIMAL(5,2)
AS
BEGIN
    -- Show employees before raise
    PRINT 'Employees before raise:';
    SELECT employee_id, first_name, last_name, salary
    FROM employees 
    WHERE department_id = &#64;department_id;
    
    -- Give the raise
    UPDATE employees
    SET salary = salary * (1 + &#64;raise_percentage / 100)
    WHERE department_id = &#64;department_id;
    
    -- Show employees after raise
    PRINT 'Employees after ' + CAST(&#64;raise_percentage AS VARCHAR) + '% raise:';
    SELECT 
        employee_id, 
        first_name, 
        last_name, 
        salary as new_salary,
        &#64;raise_percentage as raise_given_percent
    FROM employees 
    WHERE department_id = &#64;department_id;
END;

-- How to use these procedures
EXEC dbo.FindTopPerformers;
EXEC dbo.FindDepartmentsWithHighEarners &#64;minimum_salary = 80000;
EXEC dbo.FindEmptyDepartments;
EXEC dbo.GiveSalaryRaises &#64;department_id = 1, &#64;raise_percentage = 5.0;</code></pre>
                <p>Stored procedures let you do multiple database operations together. They can search for data, update information, and show results all in one command.</p>
            </div>
            
            <div class="step">
                <h4>Step 3: Advanced Procedures - Complex Business Operations</h4>
                <pre><code>-- Procedure to create a detailed company report
CREATE PROCEDURE dbo.CreateCompanyReport
AS
BEGIN
    -- Step 1: Create temporary table for high earners
    SELECT 
        employee_id, 
        first_name, 
        last_name, 
        salary, 
        department_id
    INTO #high_earners
    FROM employees
    WHERE salary > 70000;
    
    -- Step 2: Create department summary
    SELECT 
        d.department_name,
        COUNT(he.employee_id) as high_earner_count,
        AVG(he.salary) as avg_high_earner_salary,
        MAX(he.salary) as highest_salary
    FROM departments d
    LEFT JOIN #high_earners he ON d.department_id = he.department_id
    GROUP BY d.department_name
    ORDER BY high_earner_count DESC;
    
    -- Clean up temporary table
    DROP TABLE #high_earners;
END;

-- Procedure to find employee hierarchy (who reports to whom)
CREATE PROCEDURE dbo.ShowEmployeeHierarchy
    &#64;start_manager_id INT = NULL
AS
BEGIN
    -- Create table to store hierarchy
    CREATE TABLE #hierarchy (
        employee_id INT,
        first_name VARCHAR(50),
        last_name VARCHAR(50),
        manager_id INT,
        level INT,
        full_path VARCHAR(500)
    );
    
    -- Insert top-level employees (managers with no boss)
    INSERT INTO #hierarchy
    SELECT 
        employee_id,
        first_name,
        last_name,
        manager_id,
        1 as level,
        first_name + ' ' + last_name as full_path
    FROM employees
    WHERE manager_id IS NULL OR manager_id = &#64;start_manager_id;
    
    -- Find employees under each manager (simplified version)
    INSERT INTO #hierarchy
    SELECT 
        e.employee_id,
        e.first_name,
        e.last_name,
        e.manager_id,
        2 as level,
        h.full_path + ' -> ' + e.first_name + ' ' + e.last_name
    FROM employees e
    JOIN #hierarchy h ON e.manager_id = h.employee_id
    WHERE h.level = 1;
    
    -- Show the hierarchy
    SELECT 
        employee_id,
        first_name,
        last_name,
        level,
        full_path
    FROM #hierarchy
    ORDER BY level, last_name;
    
    -- Clean up
    DROP TABLE #hierarchy;
END;

-- Procedure to rank employees by salary
CREATE PROCEDURE dbo.RankEmployeesBySalary
    &#64;top_employees_per_department INT = 3
AS
BEGIN
    -- Show top earners in each department
    SELECT 
        d.department_name,
        e.first_name,
        e.last_name,
        e.salary,
        RANK() OVER(PARTITION BY e.department_id ORDER BY e.salary DESC) as dept_rank,
        RANK() OVER(ORDER BY e.salary DESC) as company_rank
    FROM employees e
    JOIN departments d ON e.department_id = d.department_id
    WHERE RANK() OVER(PARTITION BY e.department_id ORDER BY e.salary DESC) <= &#64;top_employees_per_department
    ORDER BY d.department_name, e.salary DESC;
END;

-- Safe procedure with transaction control
CREATE PROCEDURE dbo.SafelyUpdateSalaries
    &#64;department_id INT,
    &#64;raise_percentage DECIMAL(5,2)
AS
BEGIN
    -- Start transaction for safety
    BEGIN TRANSACTION;
    
    BEGIN TRY
        -- Log what we're doing
        PRINT 'Starting salary update for department ' + CAST(&#64;department_id AS VARCHAR);
        
        -- Make sure department exists
        IF NOT EXISTS (SELECT 1 FROM departments WHERE department_id = &#64;department_id)
        BEGIN
            THROW 50001, 'Department does not exist!', 1;
        END
        
        -- Update the salaries
        UPDATE employees
        SET salary = salary * (1 + &#64;raise_percentage / 100)
        WHERE department_id = &#64;department_id;
        
        -- Show results
        SELECT 
            employee_id,
            first_name,
            last_name,
            salary as new_salary
        FROM employees
        WHERE department_id = &#64;department_id;
        
        -- Save changes
        COMMIT TRANSACTION;
        PRINT 'Salary update completed successfully!';
        
    END TRY
    BEGIN CATCH
        -- Cancel changes if error occurs
        ROLLBACK TRANSACTION;
        PRINT 'Error occurred: ' + ERROR_MESSAGE();
    END CATCH;
END;

-- How to use these advanced procedures
EXEC dbo.CreateCompanyReport;
EXEC dbo.ShowEmployeeHierarchy &#64;start_manager_id = NULL;
EXEC dbo.RankEmployeesBySalary &#64;top_employees_per_department = 5;
EXEC dbo.SafelyUpdateSalaries &#64;department_id = 1, &#64;raise_percentage = 5.0;</code></pre>
                <p>Advanced procedures can create reports, show relationships between employees, rank people by performance, and safely update data with error protection. They use temporary tables and transactions to handle complex business operations.</p>
            </div>
        </div>
    </div>