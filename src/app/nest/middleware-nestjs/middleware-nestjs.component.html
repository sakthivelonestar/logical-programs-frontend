<div class="overall-wrapper" appMaximize #nestjsMiddleware="maximize" id="nestjsMiddleware">
  <div class="wrapper">
       <img class="swap" *ngIf="nestjsMiddleware.checkfullscreen() == 'hide'" (click)="nestjsMiddleware.toggle()" src="../../../assets/expand.svg" alt="Expand">
       <img class="swap" *ngIf="nestjsMiddleware.checkfullscreen() != 'hide'" (click)="nestjsMiddleware.toggle()" src="../../../assets/Minimize icon.svg" alt="Minimize">
       <div class="header">
           <p> <span class="question">What:</span>
               NestJS <strong>Middleware</strong> are functions or classes that execute during the request-response cycle, before or after controllers. They handle tasks like logging, authentication, or modifying requests/responses.
           </p>
           <p> <span class="question">Why:</span>
               Middleware enables <strong>cross-cutting concerns</strong>, such as request logging, authentication, or input validation, promoting reusability and separation of concerns in a modular way.
           </p>
           <p> <span class="question">Where:</span>
               Used in <strong>REST APIs, GraphQL applications, microservices,</strong> and web applications to process incoming requests, enforce security, or transform data before reaching controllers.
           </p>
       </div>
   </div>
   
   <div class="examples">
     <div class="step">
       <h2>1. Basic Middleware Setup</h2>
       <p>Let's create a basic middleware to log incoming requests:</p>
       
       <h3>Creating a Logger Middleware</h3>
       <pre><code><span class="comment">// logger.middleware.ts</span>
<span class="keyword">import</span> &#123; <span class="type">Injectable</span>, <span class="type">NestMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">'&#64;nestjs/common'</span>;
<span class="keyword">import</span> &#123; <span class="type">Request</span>, <span class="type">Response</span>, <span class="type">NextFunction</span> &#125; <span class="keyword">from</span> <span class="string">'express'</span>;

<span class="decorator">&#64;Injectable</span>()
<span class="keyword">export class</span> <span class="type">LoggerMiddleware</span> <span class="keyword">implements</span> <span class="type">NestMiddleware</span> &#123;
  use(req: <span class="type">Request</span>, res: <span class="type">Response</span>, next: <span class="type">NextFunction</span>) &#123;
    console.log(`Request: $&#123;req.method&#125; $&#123;req.originalUrl&#125; at $&#123;<span class="keyword">new</span> <span class="type">Date</span>().toISOString()&#125;`);
    next();
  &#125;
&#125;
</code></pre>

       <h3>Key Middleware Elements</h3>
       <div class="feature-grid">
         <div class="feature-card">
           <h4>NestMiddleware</h4>
           <p>Interface for middleware classes with a <code>use</code> method</p>
         </div>
         <div class="feature-card">
           <h4>Request/Response</h4>
           <p>Access to Express request and response objects</p>
         </div>
         <div class="feature-card">
           <h4>NextFunction</h4>
           <p>Calls the next middleware or route handler</p>
         </div>
         <div class="feature-card">
           <h4>Injectable</h4>
           <p>Allows dependency injection in middleware</p>
         </div>
       </div>
     </div>

     <div class="step">
       <h2>2. Applying Middleware</h2>
       <p>Middleware can be applied to specific routes, controllers, or globally:</p>

       <h3>Step 1: Apply Middleware to a Module</h3>
       <p>Configure middleware in a module for specific routes:</p>
       <pre><code><span class="comment">// users.module.ts</span>
<span class="keyword">import</span> &#123; <span class="type">Module</span>, <span class="type">NestModule</span>, <span class="type">MiddlewareConsumer</span> &#125; <span class="keyword">from</span> <span class="string">'&#64;nestjs/common'</span>;
<span class="keyword">import</span> &#123; <span class="type">UsersController</span> &#125; <span class="keyword">from</span> <span class="string">'./users.controller'</span>;
<span class="keyword">import</span> &#123; <span class="type">UsersService</span> &#125; <span class="keyword">from</span> <span class="string">'./users.service'</span>;
<span class="keyword">import</span> &#123; <span class="type">LoggerMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">'./logger.middleware'</span>;

<span class="decorator">&#64;Module</span>(&#123;
  controllers: [<span class="type">UsersController</span>],
  providers: [<span class="type">UsersService</span>]
&#125;)
<span class="keyword">export class</span> <span class="type">UsersModule</span> <span class="keyword">implements</span> <span class="type">NestModule</span> &#123;
  configure(consumer: <span class="type">MiddlewareConsumer</span>) &#123;
    consumer
      .apply(<span class="type">LoggerMiddleware</span>)
      .forRoutes(<span class="string">'api/users'</span>);
  &#125;
&#125;
</code></pre>

       <h3>Step 2: Apply Middleware Globally</h3>
       <p>Configure middleware globally in the main application:</p>
       <pre><code><span class="comment">// main.ts</span>
<span class="keyword">import</span> &#123; <span class="type">NestFactory</span> &#125; <span class="keyword">from</span> <span class="string">'&#64;nestjs/core'</span>;
<span class="keyword">import</span> &#123; <span class="type">AppModule</span> &#125; <span class="keyword">from</span> <span class="string">'./app.module'</span>;
<span class="keyword">import</span> &#123; <span class="type">LoggerMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">'./logger.middleware'</span>;

<span class="keyword">async function</span> bootstrap() &#123;
  <span class="keyword">const</span> app = <span class="keyword">await</span> <span class="type">NestFactory</span>.create(<span class="type">AppModule</span>);
  app.use(<span class="keyword">new</span> <span class="type">LoggerMiddleware</span>().use.bind(<span class="keyword">new</span> <span class="type">LoggerMiddleware</span>()));
  <span class="keyword">await</span> app.listen(3000);
&#125;
bootstrap();
</code></pre>

       <h3>Step 3: Middleware with Dependencies</h3>
       <p>Use dependency injection in middleware:</p>
       <pre><code><span class="comment">// auth.middleware.ts</span>
<span class="keyword">import</span> &#123; <span class="type">Injectable</span>, <span class="type">NestMiddleware</span>, <span class="type">UnauthorizedException</span> &#125; <span class="keyword">from</span> <span class="string">'&#64;nestjs/common'</span>;
<span class="keyword">import</span> &#123; <span class="type">Request</span>, <span class="type">Response</span>, <span class="type">NextFunction</span> &#125; <span class="keyword">from</span> <span class="string">'express'</span>;
<span class="keyword">import</span> &#123; <span class="type">UsersService</span> &#125; <span class="keyword">from</span> <span class="string">'./users.service'</span>;

<span class="decorator">&#64;Injectable</span>()
<span class="keyword">export class</span> <span class="type">AuthMiddleware</span> <span class="keyword">implements</span> <span class="type">NestMiddleware</span> &#123;
  <span class="keyword">constructor</span>(<span class="keyword">private</span> usersService: <span class="type">UsersService</span>) &#123;&#125;

  use(req: <span class="type">Request</span>, res: <span class="type">Response</span>, next: <span class="type">NextFunction</span>) &#123;
    <span class="keyword">const</span> authHeader = req.headers.authorization;
    <span class="keyword">if</span> (!authHeader) &#123;
      <span class="keyword">throw new</span> <span class="type">UnauthorizedException</span>(<span class="string">'Authorization header missing'</span>);
    &#125;
    <span class="keyword">const</span> userId = +authHeader.split(<span class="string">' '</span>)[1]; <span class="comment">// Simplified token parsing</span>
    <span class="keyword">const</span> user = <span class="keyword">this</span>.usersService.findOne(userId);
    <span class="keyword">if</span> (!user) &#123;
      <span class="keyword">throw new</span> <span class="type">UnauthorizedException</span>(<span class="string">'Invalid user'</span>);
    &#125;
    req.user = user;
    next();
  &#125;
&#125;
</code></pre>

       <h3>Key Points</h3>
       <ul>
         <li>Middleware processes requests before controllers.</li>
         <li>Apply middleware to specific routes or globally.</li>
         <li>Use <code>NestModule</code> for module-level middleware.</li>
         <li>Middleware supports dependency injection.</li>
       </ul>
     </div>

     <div class="step">
       <h2>3. Advanced Middleware Features</h2>
       <p>Middleware can handle complex tasks like authentication or request transformation:</p>

       <h3>Functional Middleware</h3>
       <p>Create a simple function-based middleware:</p>
       <pre><code><span class="comment">// request-id.middleware.ts</span>
<span class="keyword">import</span> &#123; <span class="type">Request</span>, <span class="type">Response</span>, <span class="type">NextFunction</span> &#125; <span class="keyword">from</span> <span class="string">'express'</span>;

<span class="keyword">export function</span> requestIdMiddleware(req: <span class="type">Request</span>, res: <span class="type">Response</span>, next: <span class="type">NextFunction</span>) &#123;
  req[<span class="string">'requestId'</span>] = Math.random().toString(36).substring(2);
  next();
&#125;
</code></pre>

       <h3>Applying Multiple Middleware</h3>
       <p>Chain multiple middleware for a route:</p>
       <pre><code><span class="comment">// users.module.ts</span>
<span class="keyword">import</span> &#123; <span class="type">Module</span>, <span class="type">NestModule</span>, <span class="type">MiddlewareConsumer</span> &#125; <span class="keyword">from</span> <span class="string">'&#64;nestjs/common'</span>;
<span class="keyword">import</span> &#123; <span class="type">UsersController</span> &#125; <span class="keyword">from</span> <span class="string">'./users.controller'</span>;
<span class="keyword">import</span> &#123; <span class="type">UsersService</span> &#125; <span class="keyword">from</span> <span class="string">'./users.service'</span>;
<span class="keyword">import</span> &#123; <span class="type">LoggerMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">'./logger.middleware'</span>;
<span class="keyword">import</span> &#123; <span class="type">AuthMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">'./auth.middleware'</span>;
<span class="keyword">import</span> &#123; requestIdMiddleware &#125; <span class="keyword">from</span> <span class="string">'./request-id.middleware'</span>;

<span class="decorator">&#64;Module</span>(&#123;
  controllers: [<span class="type">UsersController</span>],
  providers: [<span class="type">UsersService</span>]
&#125;)
<span class="keyword">export class</span> <span class="type">UsersModule</span> <span class="keyword">implements</span> <span class="type">NestModule</span> &#123;
  configure(consumer: <span class="type">MiddlewareConsumer</span>) &#123;
    consumer
      .apply(requestIdMiddleware, <span class="type">LoggerMiddleware</span>, <span class="type">AuthMiddleware</span>)
      .forRoutes(<span class="type">UsersController</span>);
  &#125;
&#125;
</code></pre>

       <h3>Excluding Routes</h3>
       <p>Exclude specific routes from middleware:</p>
       <pre><code><span class="comment">// users.module.ts</span>
<span class="keyword">import</span> &#123; <span class="type">Module</span>, <span class="type">NestModule</span>, <span class="type">MiddlewareConsumer</span> &#125; <span class="keyword">from</span> <span class="string">'&#64;nestjs/common'</span>;
<span class="keyword">import</span> &#123; <span class="type">UsersController</span> &#125; <span class="keyword">from</span> <span class="string">'./users.controller'</span>;
<span class="keyword">import</span> &#123; <span class="type">UsersService</span> &#125; <span class="keyword">from</span> <span class="string">'./users.service'</span>;
<span class="keyword">import</span> &#123; <span class="type">AuthMiddleware</span> &#125; <span class="keyword">from</span> <span class="string">'./auth.middleware'</span>;

<span class="decorator">&#64;Module</span>(&#123;
  controllers: [<span class="type">UsersController</span>],
  providers: [<span class="type">UsersService</span>]
&#125;)
<span class="keyword">export class</span> <span class="type">UsersModule</span> <span class="keyword">implements</span> <span class="type">NestModule</span> &#123;
  configure(consumer: <span class="type">MiddlewareConsumer</span>) &#123;
    consumer
      .apply(<span class="type">AuthMiddleware</span>)
      .exclude(
        &#123; path: <span class="string">'api/users'</span>, method: <span class="type">RequestMethod</span>.GET &#125;
      )
      .forRoutes(<span class="type">UsersController</span>);
  &#125;
&#125;
</code></pre>

       <h3>Key Points</h3>
       <ul>
         <li>Functional middleware is lightweight for simple tasks.</li>
         <li>Chain multiple middleware for complex logic.</li>
         <li>Exclude routes to bypass middleware for specific paths.</li>
         <li>Middleware executes in the order applied.</li>
       </ul>
     </div>

     <div class="step">
       <h2>4. Best Practices for Middleware</h2>
       <p>Organize middleware for scalability and maintainability:</p>
       
       <h3>Directory Structure</h3>
       <pre><code><span class="comment">// Recommended project structure</span>
project/
├── src/
│   ├── users/
│   │   ├── middleware/
│   │   │   ├── logger.middleware.ts
│   │   │   ├── auth.middleware.ts
│   │   │   └── request-id.middleware.ts
│   │   ├── users.controller.ts
│   │   ├── users.service.ts
│   │   └── users.module.ts
│   ├── app.module.ts
│   └── main.ts
</code></pre>

       <h3>Best Practices</h3>
       <div class="feature-grid">
         <div class="feature-card">
           <h4>Single Responsibility</h4>
           <p>Each middleware should handle one specific task</p>
         </div>
         <div class="feature-card">
           <h4>Modular Middleware</h4>
           <p>Group middleware by feature in dedicated folders</p>
         </div>
         <div class="feature-card">
           <h4>Order Matters</h4>
           <p>Apply middleware in the correct order for desired behavior</p>
         </div>
         <div class="feature-card">
           <h4>Minimal Scope</h4>
           <p>Apply middleware only to necessary routes</p>
         </div>
       </div>
     </div>

     <div class="interview-questions step">
       <h2>15 Important Interview Questions on NestJS Middleware</h2>
       <ol class="question-list">
         <li>
           <strong class="question-title">What is middleware in NestJS?</strong>
           <p class="answer">Middleware are functions or classes that process requests before or after controllers, handling tasks like logging or authentication.</p>
           <span class="category">Basics</span>
         </li>
         <li>
           <strong class="question-title">How do you create middleware in NestJS?</strong>
           <p class="answer">Implement <code>NestMiddleware</code> with a <code>use</code> method or create a function with <code>req</code>, <code>res</code>, and <code>next</code> parameters.</p>
           <span class="category">Basics</span>
         </li>
         <li>
           <strong class="question-title">What is the role of the use method?</strong>
           <p class="answer">The <code>use</code> method in middleware processes the request and response, calling <code>next()</code> to proceed.</p>
           <span class="category">Middleware</span>
         </li>
         <li>
           <strong class="question-title">How do you apply middleware to a module?</strong>
           <p class="answer">Implement <code>NestModule</code> and use <code>MiddlewareConsumer</code> in the <code>configure</code> method.</p>
           <span class="category">Middleware</span>
         </li>
         <li>
           <strong class="question-title">How do you apply middleware globally?</strong>
           <p class="answer">Use <code>app.use()</code> in <code>main.ts</code> with the middleware’s <code>use</code> method.</p>
           <span class="category">Middleware</span>
         </li>
         <li>
           <strong class="question-title">What is MiddlewareConsumer?</strong>
           <p class="answer">A utility to apply middleware to specific routes or controllers in a module.</p>
           <span class="category">Middleware</span>
         </li>
         <li>
           <strong class="question-title">How do you exclude routes from middleware?</strong>
           <p class="answer">Use the <code>exclude</code> method in <code>MiddlewareConsumer</code> with path and method specifications.</p>
           <span class="category">Middleware</span>
         </li>
         <li>
           <strong class="question-title">Can middleware use dependency injection?</strong>
           <p class="answer">Yes, class-based middleware with <code> &#64;Injectable()</code> supports dependency injection.</p>
           <span class="category">Middleware</span>
         </li>
         <li>
           <strong class="question-title">What is the difference between functional and class-based middleware?</strong>
           <p class="answer">Functional middleware is simpler, while class-based middleware supports dependency injection and modularity.</p>
           <span class="category">Middleware</span>
         </li>
         <li>
           <strong class="question-title">How do you chain multiple middleware?</strong>
           <p class="answer">Pass multiple middleware to the <code>apply</code> method in <code>MiddlewareConsumer</code>.</p>
           <span class="category">Middleware</span>
         </li>
         <li>
           <strong class="question-title">Why is middleware order important?</strong>
           <p class="answer">Middleware executes sequentially, so order affects request processing logic.</p>
           <span class="category">Best Practices</span>
         </li>
         <li>
           <strong class="question-title">How do you handle errors in middleware?</strong>
           <p class="answer">Throw exceptions (e.g., <code>UnauthorizedException</code>) or pass errors to <code>next(err)</code>.</p>
           <span class="category">Middleware</span>
         </li>
         <li>
           <strong class="question-title">What is a common use case for middleware?</strong>
           <p class="answer">Authentication, logging, request transformation, or rate limiting.</p>
           <span class="category">Use Cases</span>
         </li>
         <li>
           <strong class="question-title">How do you test middleware?</strong>
           <p class="answer">Use unit tests to mock <code>req</code>, <code>res</code>, and <code>next</code>, verifying middleware behavior.</p>
           <span class="category">Testing</span>
         </li>
         <li>
           <strong class="question-title">How does middleware differ from interceptors?</strong>
           <p class="answer">Middleware runs before controllers and lacks access to NestJS context, while interceptors run in the NestJS pipeline with more control.</p>
           <span class="category">Middleware</span>
         </li>
       </ol>
     </div>
   </div>
</div>